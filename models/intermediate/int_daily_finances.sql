WITH COMPLETED_ORDERS AS (
    SELECT
        O.ORDER_ID,
        SESSION_ID,
        CAST(ORDER_AT_TS AS DATE) AS ORDER_DATE,
        SHIPPING_COST,
        TAX_RATE
    FROM
        {{ref('base_web_orders')}} O
    LEFT JOIN
        {{ref('base_google_drive_returns')}} R
    ON
        O.ORDER_ID = R.ORDER_ID
    WHERE
        R.ORDER_ID IS NULL OR IS_REFUNDED_BOOLEAN = FALSE
),

ITEMS_SOLD AS (
    SELECT
        SESSION_ID,
        SUM((ADD_TO_CART_QUANTITY - REMOVE_FROM_CART_QUANTITY) * PRICE_PER_UNIT) AS SOLD_VALUE
    FROM
        {{ref('base_web_item_views')}}
    WHERE
        ADD_TO_CART_QUANTITY != 0
    GROUP BY
        SESSION_ID
),

ORDER_REVENUE AS (
    SELECT
        ORDER_DATE,
        SUM(SOLD_VALUE) AS DAILY_REVENUE,
        SUM(SHIPPING_COST) AS DAILY_SHIPPING_COST,
        SUM((SOLD_VALUE + SHIPPING_COST) * TAX_RATE) AS DAILY_TAX
    FROM COMPLETED_ORDERS C
    INNER JOIN ITEMS_SOLD S
    ON C.SESSION_ID = S.SESSION_ID
    GROUP BY 1
),

DAILY_EXPENSE AS (
    SELECT 
        EXPENSES_DATE,
        SUM(EXPENSE_AMOUNT) AS TOTAL_EXPENSE_AMOUNT
    FROM 
        {{ref('base_google_drive_expenses')}}
    GROUP BY 
        EXPENSES_DATE
),

ORDER_EXPENSE AS (
    SELECT
        COALESCE(ORDER_DATE, EXPENSES_DATE) AS DATE,
        DAILY_REVENUE,
        DAILY_SHIPPING_COST,
        DAILY_TAX,
        TOTAL_EXPENSE_AMOUNT AS DAILY_EXPENSE
    FROM
        ORDER_REVENUE R
    FULL OUTER JOIN
        DAILY_EXPENSE E
    ON
        R.ORDER_DATE = E.EXPENSES_DATE
),

EMPLOYEE_COST AS (
    SELECT 
        J.EMPLOYEE_ID,
        EMPLOYEE_HIRE_DATE,
        EMPLOYEE_ANNUAL_SALARY,
        EMPLOYEE_QUIT_DATE,
        EMPLOYEE_ANNUAL_SALARY / 365 AS DAILY_SALARY
    FROM 
        {{ref('base_GOOGLE_DRIVE_requests_JOINS')}} AS J
    LEFT JOIN 
        {{ref('base_GOOGLE_DRIVE_requests_QUITS')}} AS Q
    ON 
        J.EMPLOYEE_ID = Q.EMPLOYEE_ID
)

SELECT
    DATE,
    DAILY_REVENUE,
    DAILY_SHIPPING_COST,
    DAILY_TAX,
    DAILY_EXPENSE,
    SUM(DAILY_SALARY) AS DAILY_SALARY
FROM ORDER_EXPENSE O
LEFT JOIN EMPLOYEE_COST C
ON O.DATE >= C.EMPLOYEE_HIRE_DATE
    AND (O.DATE <= C.EMPLOYEE_QUIT_DATE OR C.EMPLOYEE_QUIT_DATE IS NULL)
GROUP BY 1, 2, 3, 4, 5
ORDER BY 1